name: AvicaRDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Download and Setup Avica & Dependencies
        shell: pwsh
        run: |
          Write-Host "🚀 Starting Avica setup directly..." -ForegroundColor Green

          # Download files
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"

          # Install Python packages
          python -m pip install requests pyautogui telegraph --quiet

          # Enable RDP and firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Set user password
          net user runneradmin TheDisa1a

          Write-Host "✅ Setup completed! Ready to launch Avica." -ForegroundColor Green

      - name: Show Connection Info
        shell: pwsh
        run: |
          Write-Host "
          ╔══════════════════════════════════════╗
          ║        AVICA RDP CONNECTION          ║  
          ╚══════════════════════════════════════╝

          📱 Telegram : @TheNetworkZoneOfficial
          👨‍💻 Credits : @PiroYadav & @TheYadavNetwork

          📋 Instructions:
          • Go to the GoFile link that will appear below
          • Get Avica ID and Password from there
          • Download Avica app and connect
          • GoFile link changes every time!

          ⏳ Waiting for GoFile link...
          " -ForegroundColor Cyan

      - name: Start Avica and Python Setup
        shell: pwsh
        run: |
          Start-Process ".\Avica_setup.exe"
          python setup.py

      - name: Minimize CMD, Take Screenshot, Upload to GoFile
        shell: pwsh
        run: |
          # Try to minimize all command windows (best effort, will have no effect in headless CI)
          try {
            Add-Type -AssemblyName System.Windows.Forms
            [System.Windows.Forms.SendKeys]::SendWait('% {TAB}')
          } catch {
            Write-Host "Minimize attempt failed or not supported on runner."
          }
          # Take screenshot and upload to GoFile
          python -c "import pyautogui,requests,time;time.sleep(2);ss=pyautogui.screenshot();ss.save('screen.png');with open('screen.png','rb') as f:r=requests.post('https://api.gofile.io/uploadFile',files={'file':f});link=r.json().get('data',{}).get('downloadPage','No link');print(f'GoFile Link: {link}')"

      - name: Start Avica Service (Show.bat)
        run: cmd /c show.bat

      - name: Keep Session Active (Loop.bat)
        run: cmd /c loop.bat
